sudo: required

language: python

services:
  - docker

before_install:
  - CHANGED_FILES=($(git diff --name-only $TRAVIS_COMMIT_RANGE))
  - echo $CHANGED_FILES
  - >
    for file in $CHANGED_FILES; do
      if [[ $file =~ "Dockerfile" ]]; then
        dockerfile=$file
        image=${dockerfile#Dockerfile.}
        # Put Travis to sleep
        travis_wait 40 sleep infinity &
        sleep_PID=$!
        echo $sleep_PID
        docker build --tag "$DOCKER_USERNAME"/$image --file $dockerfile .
        kill -9 $sleep_PID
        docker login --username "$DOCKER_USERNAME" --password-stdin "$DOCKER_PASSWORD"
        travis_wait 20 sleep infinity &
        sleep_PID=$!
        echo $sleep_PID
        docker push "$DOCKER_USERNAME"/$image
        kill -9 $sleep_PID
      fi
    done

script:
  - python -c "import sys; print(sys.version)"
